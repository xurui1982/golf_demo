# 高尔夫挥杆分析系统设计文档

## 1. 项目概述

### 目标
为有一定水平的高尔夫爱好者提供基于 AI 的挥杆分析工具，通过高速视频录像自动分析挥杆动作和球的飞行数据，给出专业的改进建议。

### 目标用户
- 有一定基础的高尔夫爱好者
- 对挥杆技术有认知，需要精细化分析反馈
- 希望通过数据驱动的方式提升技术

### 使用场景
- 室外练习场/球场：手机慢动作拍摄
- 室内模拟器/训练室：固定机位拍摄
- 系统需适配不同光线和拍摄条件

### 运行环境
- M1 Mac mini（或同等性能设备）
- 通过 Claude Code 命令行运行
- 初期不打包成应用

---

## 2. 输入规格

### 视频要求
| 参数 | 要求 | 说明 |
|------|------|------|
| 帧率 | 240fps（推荐） | iPhone 慢动作模式，用于球追踪 |
| 分辨率 | 1080p 以上 | 确保人体和球的细节清晰 |
| 格式 | MP4/MOV | 常见视频格式 |
| 时长 | 3-10 秒 | 单次完整挥杆 |

### 拍摄角度
- **主要：背面视角 (Down-the-line)** - 从球飞行方向后方拍摄
  - 适合分析：挥杆平面、脊柱角度、手臂路径、球飞行方向
- **辅助：侧面视角 (Face-on)** - 可选，面对球手拍摄
  - 适合分析：重心转移、髋部旋转、手臂位置

### 拍摄建议
- 全身入镜，头顶和脚下留有空间
- 球和球手都在画面中
- 背景尽量简洁，避免干扰检测
- 光线充足，避免逆光

---

## 3. 核心功能模块

### 3.1 人体姿态分析
使用 MediaPipe Pose 提取 33 个身体关键点，分析：

**挥杆阶段自动检测：**
1. Setup（准备） - 站姿、握杆
2. Backswing（上杆） - 杆头启动到顶点
3. Top（顶点） - 上杆最高位置
4. Downswing（下杆） - 顶点到击球
5. Impact（击球） - 杆头触球瞬间
6. Follow-through（收杆） - 击球后的延续动作

**关键指标：**
- 脊柱角度 (Spine Angle) - 前倾角度的稳定性
- 髋肩分离 (X-Factor) - 髋部与肩部的旋转差
- 挥杆平面 (Swing Plane) - 杆头运动轨迹的一致性
- 重心转移 - 左右脚的压力变化
- 头部稳定性 - 击球过程中头部位置变化

### 3.2 球追踪分析
使用 OpenCV 进行球检测和追踪：

**检测方法：**
- 颜色过滤（白色球）+ 霍夫圆检测
- 或使用 CSRT/KCF 追踪算法
- 240fps 下每帧球移动约 17-29cm，可连续追踪

**输出数据：**
- 击球点位置 - 杆面触球的位置
- 起飞角度 (Launch Angle) - 球离开杆面的垂直角度
- 起飞方向 - 相对于目标线的左右偏移
- 初始球速估算 - 基于帧间位移计算
- 飞行轨迹 - 球在画面内的运动路径

### 3.3 节奏分析
基于挥杆阶段的时间分布：

- 上杆时间 vs 下杆时间比例（理想约 3:1）
- 各阶段时间稳定性
- 与标准节奏的对比

### 3.4 智能建议生成
使用 Claude 视觉能力：

- 输入：关键帧图片 + 姿态数据 + 球追踪数据
- 分析：识别动作问题，与标准动作对比
- 输出：自然语言的改进建议，优先级排序

---

## 4. 技术架构

### 处理流程
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  视频输入   │────▶│   帧提取    │────▶│  并行处理   │
│  (240fps)   │     │  (ffmpeg)   │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                    ┌──────────────────────────┼──────────────────────────┐
                    │                          │                          │
                    ▼                          ▼                          ▼
           ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
           │  姿态估计   │            │   球追踪    │            │  杆头追踪   │
           │ (MediaPipe) │            │  (OpenCV)   │            │  (OpenCV)   │
           └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
                  │                          │                          │
                  └──────────────────────────┼──────────────────────────┘
                                             │
                                             ▼
                                    ┌─────────────┐
                                    │  数据融合   │
                                    │   & 计算    │
                                    └──────┬──────┘
                                           │
                    ┌──────────────────────┴──────────────────────┐
                    │                                             │
                    ▼                                             ▼
           ┌─────────────┐                               ┌─────────────┐
           │  可视化生成  │                               │ Claude 分析 │
           │  (OpenCV)   │                               │  (API)      │
           └──────┬──────┘                               └──────┬──────┘
                  │                                             │
                  ▼                                             ▼
           ┌─────────────┐                               ┌─────────────┐
           │ 叠加视频/图片│                               │  智能建议   │
           └─────────────┘                               └─────────────┘
```

### 技术栈
| 组件 | 技术选型 | 用途 |
|------|----------|------|
| 视频处理 | ffmpeg | 帧提取、视频编码 |
| 图像处理 | OpenCV | 球检测、追踪、可视化 |
| 姿态估计 | MediaPipe Pose | 人体 33 关键点提取 |
| 数值计算 | NumPy | 角度、轨迹、速度计算 |
| 可视化 | Matplotlib | 图表、轨迹图 |
| 智能分析 | Claude API | 关键帧分析、建议生成 |
| 运行环境 | Python 3.10+ | M1 Mac 原生支持 |

### 依赖安装
```bash
pip install mediapipe opencv-python numpy matplotlib anthropic
brew install ffmpeg
```

---

## 5. 输出格式

### 5.1 静态分析报告
生成 HTML 或 Markdown 格式的报告，包含：

```
output/
├── report.html           # 完整分析报告
├── keyframes/            # 关键帧截图
│   ├── 01_setup.jpg
│   ├── 02_backswing.jpg
│   ├── 03_top.jpg
│   ├── 04_downswing.jpg
│   ├── 05_impact.jpg
│   └── 06_followthrough.jpg
├── data/
│   ├── pose_data.json    # 姿态关键点数据
│   ├── ball_track.json   # 球追踪数据
│   └── metrics.json      # 计算指标
└── charts/
    ├── swing_plane.png   # 挥杆平面图
    ├── angles.png        # 角度变化曲线
    └── ball_trajectory.png # 球飞行轨迹
```

### 5.2 叠加可视化视频
在原视频上叠加：
- 人体骨骼连线（彩色）
- 关节角度标注
- 球的位置和轨迹线
- 杆头轨迹
- 当前阶段标识

输出为 MP4 文件，可分享或保存。

### 5.3 分析报告内容
```markdown
# 挥杆分析报告

## 基本数据
- 上杆时间: 0.85s
- 下杆时间: 0.28s
- 节奏比: 3.0:1 ✅
- 球初速: ~145 km/h
- 起飞角度: 12.5°
- 起飞方向: 右偏 2°

## 姿态分析
### 优点
1. 脊柱角度稳定，击球时保持良好
2. 髋肩分离充分，X-Factor 达到 45°

### 待改进
1. 顶点时左臂略有弯曲，建议保持伸直
2. 下杆时头部有轻微前移，影响击球稳定性

## 建议
1. [优先] 练习保持左臂伸直的上杆动作
2. 下杆时注意保持头部位置不动
3. ...
```

---

## 6. 项目结构

```
golf/
├── docs/
│   └── plans/
│       └── 2026-01-29-golf-swing-analyzer-design.md
├── src/
│   ├── __init__.py
│   ├── main.py              # 主入口
│   ├── video_processor.py   # 视频帧提取
│   ├── pose_analyzer.py     # 姿态分析
│   ├── ball_tracker.py      # 球追踪
│   ├── swing_detector.py    # 挥杆阶段检测
│   ├── metrics.py           # 指标计算
│   ├── visualizer.py        # 可视化生成
│   ├── report_generator.py  # 报告生成
│   └── claude_analyzer.py   # Claude API 调用
├── output/                  # 分析结果输出目录
├── samples/                 # 测试视频
├── requirements.txt
└── README.md
```

---

## 7. 实现计划

### Phase 1: 基础框架
1. 项目初始化，安装依赖
2. 视频帧提取模块
3. MediaPipe 姿态估计集成
4. 基础可视化（骨骼叠加）

### Phase 2: 核心分析
5. 挥杆阶段自动检测
6. 关键指标计算（角度、节奏等）
7. 球追踪模块
8. 球数据计算（速度、角度）

### Phase 3: 智能建议
9. 关键帧提取和处理
10. Claude API 集成
11. 智能建议生成

### Phase 4: 输出完善
12. 叠加可视化视频生成
13. HTML 报告生成
14. 数据导出

---

## 8. 可用工具和技能

### Claude Code 工具
| 工具 | 用途 |
|------|------|
| Bash | 运行 Python 脚本、安装依赖、ffmpeg 命令 |
| Read/Write/Edit | 编写和修改代码文件 |
| Glob/Grep | 搜索和查找文件 |

### 相关 Skills
| Skill | 用途 |
|------|------|
| `superpowers:test-driven-development` | 用 TDD 方式开发核心模块 |
| `superpowers:systematic-debugging` | 调试姿态检测、球追踪问题 |
| `superpowers:writing-plans` | 写详细实现计划 |
| `document-skills:webapp-testing` | 如果后续做 Web 界面，用于测试 |

### 可考虑的 MCP Server
如果需要扩展功能，可以构建 MCP Server：
- 视频处理 MCP - 封装 ffmpeg 操作
- 姿态分析 MCP - 封装 MediaPipe 调用
- 这样可以让 Claude 直接调用分析功能

---

## 9. 风险和限制

| 风险 | 缓解措施 |
|------|----------|
| 球检测在复杂背景下失败 | 要求简洁背景；或用更强的检测模型 |
| 低光环境姿态估计不准 | 要求充足光线；预处理增强对比度 |
| 球速估算不精确 | 标注已知距离参考物做标定 |
| 非标准角度视频 | 自动检测角度，调整分析策略 |

---

## 10. 后续扩展方向

1. **多次挥杆对比** - 分析稳定性和进步趋势
2. **职业选手对比** - 导入标准模型做动作对比
3. **实时分析模式** - 连接摄像头即时反馈
4. **移动端 App** - 打包成 iOS/Android 应用
5. **Web 界面** - 可视化交互回放

